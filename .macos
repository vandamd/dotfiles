#!/usr/bin/env bash

# Close System Settings to prevent overriding
osascript -e 'tell application "System Settings" to quit'

# Ask for admin password upfront
sudo -v

# Keep sudo alive
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# General
sudo nvram SystemAudioVolume=" " # Disable boot sound

# Trackpad
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Bottom right corner = right-click
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadCornerSecondaryClick -int 2
defaults -currentHost write NSGlobalDomain com.apple.trackpad.trackpadCornerClickBehavior -int 1

# Disable natural scrolling
defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

# Keyboard
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false # Disable press-and-hold
defaults write NSGlobalDomain KeyRepeat -int 2                     # Fast key repeat
defaults write NSGlobalDomain InitialKeyRepeat -int 15

# Power
sudo pmset -a lidwake 1

# Screen
defaults write com.apple.screensaver askForPassword -int 1    # Require password after sleep
defaults write com.apple.screensaver askForPasswordDelay -int 0
defaults write NSGlobalDomain AppleFontSmoothing -int 1       # Subpixel font rendering
sudo defaults write /Library/Preferences/com.apple.windowserver DisplayResolutionEnabled -bool true # HiDPI

# Finder
defaults write com.apple.finder ShowExternalHardDrivesOnDesktop -bool false
defaults write com.apple.finder ShowHardDrivesOnDesktop -bool false
defaults write com.apple.finder ShowMountedServersOnDesktop -bool false
defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool false
defaults write NSGlobalDomain AppleShowAllExtensions -bool true
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder ShowPathbar -bool true
defaults write com.apple.finder _FXSortFoldersFirst -bool true
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf" # Search current folder
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
defaults write NSGlobalDomain com.apple.springing.enabled -bool true
defaults write NSGlobalDomain com.apple.springing.delay -float 0
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv" # List view

# Dock
defaults write com.apple.dock autohide-delay -int 0
defaults write com.apple.dock autohide-time-modifier -float 0.8
defaults write com.apple.dock tilesize -int 64
defaults write com.apple.dock mru-spaces -bool false # Don't rearrange spaces
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock show-recents -bool false
defaults write com.apple.dock persistent-apps -array # Clear dock icons

# Menu bar
defaults -currentHost write com.apple.Spotlight MenuItemHidden -int 1
defaults write com.apple.controlcenter.plist BatteryShowPercentage -bool true

# Restart affected apps
for app in "Activity Monitor" "Dock" "Finder" "SystemUIServer"; do
    killall "${app}"
done
